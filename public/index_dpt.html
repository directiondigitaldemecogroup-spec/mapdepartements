<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carte interactive Hexvia</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- üëâ IMPORTANT : on charge le fichier contenant le GEOJSON -->
    <script src="departements.js"></script>

    <style>
      html, body { margin: 0; height: 100%; font-family: system-ui, sans-serif; }
      #map { height: 100vh; width: 100%; }

      .logo-container {
        position: fixed; top: 15px; right: 15px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px; padding: 6px 10px;
        box-shadow: 0 0 6px rgba(0,0,0,0.25);
        z-index: 9999;
      }
      .logo-container img { height: 60px; background:white; padding:6px; border-radius:8px; }

      .legend {
        position: fixed; bottom: 15px; left: 15px;
        z-index: 9999; background: rgba(255,255,255,0.95);
        padding: 10px 12px; font-size: 13px;
        border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.25);
        line-height: 1.6;
      }
      .legend-marker { width: 14px; height: 14px; border-radius: 50%; border:2px solid white; display:inline-block; margin-right:6px; }

      .search-container {
        position: fixed; top: 15px; left: 15px; z-index: 9999; width: 260px;
      }
      .search-container input {
        width: 100%; padding: 8px 10px; border-radius: 6px;
        border: 1px solid #aaa; font-size: 14px; background:#fff;
      }
      .results-list {
        background: rgba(255,255,255,0.95);
        max-height: 200px; overflow-y:auto;
        border-radius: 6px; margin-top:4px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        display:none;
      }
      .result-item { padding:6px 10px; cursor:pointer; border-bottom:1px solid #eee; }
      .result-item:hover { background:#f5f5f5; }

      .popup-content { color:#000; font-size:13px; line-height:1.4; width:230px; }

      #splash-screen {
        position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.85);
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        z-index:10000; transition:opacity 0.8s ease;
      }
      #splash-screen img { width:160px; margin-bottom:25px; }
      #progress { margin-top:8px; font-size:15px; color:#ccc; font-weight:600; }
      .progress-bar { width:250px; height:10px; background:rgba(255,255,255,0.2); border-radius:5px; margin-top:12px; overflow:hidden; }
      .progress-bar-inner { height:100%; width:0%; background:#4caf50; transition: width 0.3s ease; }
    </style>
</head>

<body>

<div id="map"></div>

<div class="search-container">
  <input type="text" id="searchInput" placeholder="üîç Rechercher une agence..." />
  <div class="results-list" id="resultsList"></div>
</div>

<div class="logo-container">
  <img src="https://i.ibb.co/35w511m5/logo-hexvia.png" alt="Logo Hexvia" />
</div>

<div class="legend">
  <b>L√©gende</b><br />
  <span class="legend-marker" style="background:#2e7d32;"></span> Int√©gr√©e<br />
  <span class="legend-marker" style="background:#1565c0;"></span> Franchis√©e<br />
  <span class="legend-marker" style="background:#424242;"></span> Demeseul<br /><br />
  <b>D√©partements</b><br> D√©grad√© = nombre d‚Äôagences
</div>

<div id="splash-screen">
  <img src="https://i.ibb.co/35w511m5/logo-hexvia.png" alt="Hexvia" />
  <p style="color:#fff;margin:0 0 8px;">Chargement des agences Hexvia...</p>
  <div id="progress">0%</div>
  <div class="progress-bar"><div class="progress-bar-inner" id="progressBarInner"></div></div>
</div>

<script>
/* Airtable */
const AIRTABLE_TOKEN = "patCagDMpXwNLGyQu.ed05d2...";
const BASE_ID = "app5DoZKkIuqd6Quo";
const TABLE_ID = "tblcLGQDcypZPFbZA";

/* Map */
const map = L.map("map").setView([46.5, 2.5], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let markers = [];
let deptCounts = {};
let deptLayer = null;

/* Marker */
function buildIcon(type, note) {
  let color = "#2e7d32";
  const t = (type || "").toLowerCase();
  if (t.includes("franchise")) color="#1565c0";
  if (t.includes("demeseul")) color="#424242";
  const halo = note ? "box-shadow:0 0 8px rgba(255,215,0,0.9);" : "";
  return L.divIcon({
    html:`<div style="width:18px;height:18px;background:${color};border:2px solid #fff;border-radius:50%;${halo}"></div>`,
    className:"", iconSize:[20,20], iconAnchor:[10,10]
  });
}

/* Departement code */
function getDepartmentFromCP(cp) {
  if (!cp) return null;
  cp = cp.toString();
  if (cp.startsWith("97")) return cp.slice(0,3);
  return cp.slice(0,2);
}

/* Color scale */
function getDeptColor(count) {
  if (!count) return "#d4efdf";
  const max = Math.max(...Object.values(deptCounts));
  const ratio = count / max;
  const start=[212,239,223], end=[46,125,50];
  const r=Math.round(start[0]+(end[0]-start[0])*ratio);
  const g=Math.round(start[1]+(end[1]-start[1])*ratio);
  const b=Math.round(start[2]+(end[2]-start[2])*ratio);
  return `rgb(${r},${g},${b})`;
}

/* Dept layer */
function addDepartmentsLayer() {
  if (!FR_DEPARTEMENTS_GEOJSON) return;
  if (deptLayer) map.removeLayer(deptLayer);

  deptLayer = L.geoJSON(FR_DEPARTEMENTS_GEOJSON, {
    style: f => ({
      color:"#333", weight:1, fillOpacity:0.55,
      fillColor:getDeptColor(deptCounts[f.properties.code] || 0)
    }),
    onEachFeature:(f, layer)=>{
      const code=f.properties.code;
      const name=f.properties.nom;
      const count=deptCounts[code] || 0;
      layer.bindPopup(`<b>${name}</b><br>${code}<br>Agences : <b>${count}</b>`);
      layer.on("mouseover",()=>layer.setStyle({weight:3}));
      layer.on("mouseout",()=>layer.setStyle({weight:1}));
    }
  }).addTo(map);
}

/* Load Airtable */
async function fetchAllRecords() {
  const results=[]; let offset=null;
  do {
    const url=new URL(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}`);
    url.searchParams.set("pageSize","100");
    if(offset) url.searchParams.set("offset",offset);
    const res=await fetch(url,{headers:{Authorization:`Bearer ${AIRTABLE_TOKEN}`}});
    const data=await res.json();
    results.push(...data.records);
    offset=data.offset;
  } while(offset);
  return results;
}

/* MAIN */
async function main() {
  const splash=document.getElementById("splash-screen");
  const progress=document.getElementById("progress");
  const bar=document.getElementById("progressBarInner");

  const records = await fetchAllRecords();
  let done = 0;

  for (const rec of records) {
    const f = rec.fields;

    const lat=parseFloat(f["Latitude"]);
    const lng=parseFloat(f["Longitude"]);
    if (isNaN(lat)||isNaN(lng)) continue;

    const name=f["AGENCE "] || f["AGENCE"] || "Sans nom";
    const dept=getDepartmentFromCP(f["CODE POSTAL"]);
    if (dept) deptCounts[dept]=(deptCounts[dept]||0)+1;

    const popupHTML = `
      <div class="popup-content">
        <strong>${name}</strong><br>
        ${f["ADRESSE-OK"] || ""}<br>
        ${f["note_google"] ? `‚≠ê ${f["note_google"]}/5<br>` : ""}
        ${f["URL Avis Google"] ? `<a href="${f["URL Avis Google"]}" target="_blank">Voir les avis</a>` : ""}
      </div>
    `;

    const marker = L.marker([lat,lng], {
      icon:buildIcon(f["TYPE AGENCE"], f["note_google"])
    }).addTo(map).bindPopup(popupHTML);

    markers.push({name, marker});

    done++;
    const pct = Math.round(done / records.length * 100);
    progress.textContent=pct+"%";
    bar.style.width=pct+"%";
  }

  splash.style.opacity=0;
  setTimeout(()=>splash.remove(),1000);

  addDepartmentsLayer();
}

main();

/* Recherche */
const searchInput=document.getElementById("searchInput");
const resultsList=document.getElementById("resultsList");

searchInput.addEventListener("input",()=>{
  const q=searchInput.value.trim().toLowerCase();
  resultsList.innerHTML="";
  if(!q) return resultsList.style.display="none";

  const filtered = markers.filter(m => m.name.toLowerCase().includes(q));

  if(filtered.length===0){
    resultsList.innerHTML="<div class='result-item'>Aucune agence trouv√©e</div>";
    resultsList.style.display="block"; return;
  }

  filtered.forEach(m=>{
    const item=document.createElement("div");
    item.className="result-item";
    item.innerHTML=`<b>${m.name}</b>`;
    item.onclick=()=>{
      map.setView(m.marker.getLatLng(),13);
      m.marker.openPopup();
      resultsList.style.display="none";
    };
    resultsList.appendChild(item);
  });

  resultsList.style.display="block";
});
</script>

</body>
</html>
