<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carte interactive Hexvia</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
      html, body {
        margin: 0;
        height: 100%;
        font-family: system-ui, sans-serif;
      }
      #map { height: 100vh; width: 100%; }

      /* LOGO */
      .logo-container {
        position: fixed;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 6px 10px;
        box-shadow: 0 0 6px rgba(0,0,0,0.25);
        z-index: 9999;
      }
      .logo-container img { height: 60px; background:white; padding:6px; border-radius:8px; }

      /* LEGENDE */
      .legend {
        position: fixed;
        bottom: 15px;
        left: 15px;
        z-index: 9999;
        background: rgba(255,255,255,0.95);
        padding: 10px 12px;
        font-size: 13px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.25);
        line-height: 1.6;
      }
      .legend-marker {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid white;
        display: inline-block;
        margin-right: 6px;
      }

      /* RECHERCHE */
      .search-container {
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 9999;
        width: 260px;
      }
      .search-container input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #aaa;
        font-size: 14px;
        background:#fff;
      }
      .results-list {
        background: rgba(255,255,255,0.95);
        max-height: 200px;
        overflow-y: auto;
        border-radius: 6px;
        margin-top: 4px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        display: none;
      }
      .result-item { padding: 6px 10px; cursor: pointer; border-bottom: 1px solid #eee; }
      .result-item:hover { background: #f5f5f5; }

      /* POPUPS */
      .popup-content { color:#000; font-size:13px; line-height:1.4; width: 230px; }
      .popup-buttons { display:flex; justify-content:space-between; margin-top:8px; gap:4px; }
      .popup-btn {
        flex:1; padding:6px 8px; border:none; border-radius:4px; font-size:12px; cursor:pointer;
        font-weight:600; color:white; transition:transform .15s ease, background .3s;
      }
      .popup-btn:hover { transform: scale(1.05); }
      .btn-dir { background:#1976d2; } .btn-dir:hover { background:#1565c0; }
      .btn-contact { background:#4caf50; } .btn-contact:hover { background:#449d48; }

      .popup-extra {
        margin-top:6px; padding:6px; border-radius:5px; background:#f5f5f5; font-size:12px;
        box-shadow: inset 0 0 4px rgba(0,0,0,0.1); overflow:hidden; max-height:0; opacity:0;
        transition:max-height .35s ease, opacity .35s ease, padding .35s ease;
      }
      .popup-extra.show { max-height: 220px; opacity:1; padding:8px 6px; }

      /* Splash */
      #splash-screen {
        position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.85);
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        z-index: 10000; transition: opacity 0.8s ease; backdrop-filter: blur(4px);
      }
      #splash-screen img { width: 160px; margin-bottom: 25px; }
      #progress { margin-top: 8px; font-size: 15px; color: #ccc; font-weight: 600; }
      .progress-bar {
        width: 250px; height: 10px; background: rgba(255,255,255,0.2);
        border-radius: 5px; margin-top: 12px; overflow: hidden; box-shadow: inset 0 0 5px rgba(0,0,0,0.25);
      }
      .progress-bar-inner { height: 100%; width: 0%; background: #4caf50; transition: width 0.3s ease; }
    </style>
  </head>

<body>
<div id="map"></div>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="üîç Rechercher une agence..." />
      <div class="results-list" id="resultsList"></div>
    </div>

    <!-- LOGO HEXVIA -->
    <div class="logo-container">
      <img src="https://i.ibb.co/35w511m5/logo-hexvia.png" alt="Logo Hexvia" />
    </div>

    <!-- LEGENDE -->
    <div class="legend">
      <b>L√©gende</b><br />
      <span class="legend-marker" style="background:#2e7d32;"></span> Int√©gr√©e<br />
      <span class="legend-marker" style="background:#1565c0;"></span> Franchis√©e<br />
      <span class="legend-marker" style="background:#424242;"></span> Demeseul<br /><br />
      <b>D√©partements</b><br>
      D√©grad√© = nombre d‚Äôagences
    </div>

    <!-- Splash -->
    <div id="splash-screen">
      <img src="https://i.ibb.co/35w511m5/logo-hexvia.png" alt="Hexvia" />
      <p style="color:#fff;margin:0 0 8px;">Chargement des agences Hexvia...</p>
      <div id="progress">0%</div>
      <div class="progress-bar"><div class="progress-bar-inner" id="progressBarInner"></div></div>
    </div>

<script>
/* Airtable API */
const AIRTABLE_TOKEN = 'patCagDMpXwNLGyQu.ed05d2b62289d165c562eed44a9e04b7f424b708179f288461a499caebe77ac4';
const BASE_ID = 'app5DoZKkIuqd6Quo';
const TABLE_ID = 'tblcLGQDcypZPFbZA';

/* Leaflet */
const map = L.map('map').setView([46.5, 2.5], 6);
let markers = [];
let deptCounts = {}; // ‚Üê compteur agences / d√©partement
let deptLayer = null;

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* MARKERS MODERNES */
function buildIcon(type, note) {
  const t = (type || '').toLowerCase();
  let color = "#2e7d32";
  if (t.includes("franchise")) color = "#1565c0";
  if (t.includes("demeseul")) color = "#424242";

  const halo = note ? "box-shadow:0 0 8px rgba(255,215,0,0.9);" : "";
  return L.divIcon({
    html: `<div style="width:18px;height:18px;background:${color};border-radius:50%;border:2px solid #fff;${halo}"></div>`,
    className: "",
    iconSize: [20,20],
    iconAnchor: [10,10],
    popupAnchor: [0,-10]
  });
}

/* Airtable ‚Üí charge toutes les agences */
async function fetchAllRecords() {
  const urlBase = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}`;
  let offset = null;
  const all = [];

  do {
    const url = new URL(urlBase);
    url.searchParams.set("pageSize", "100");
    if (offset) url.searchParams.set("offset", offset);

    const res = await fetch(url, { headers:{ Authorization:`Bearer ${AIRTABLE_TOKEN}` }});
    const data = await res.json();

    (data.records || []).forEach(r => all.push(r));
    offset = data.offset;
  } while (offset);

  return all;
}

/* Extraction du d√©partement depuis CODE POSTAL */
function getDepartmentFromCP(cp) {
  if (!cp) return null;
  cp = cp.toString().trim();

  if (cp.startsWith("97")) return cp.substring(0,3);
  return cp.substring(0,2);
}
/* ----------- COUCHE D√âPARTEMENTS ----------- */

function getDeptColor(count) {
  if (!count) return "#d4efdf"; // gris / vert tr√®s clair

  const max = Math.max(...Object.values(deptCounts));
  const ratio = count / max;

  const start = [212, 239, 223]; // vert p√¢le
  const end   = [46, 125, 50];   // vert hexvia fonc√©

  const r = Math.round(start[0] + (end[0]-start[0])*ratio);
  const g = Math.round(start[1] + (end[1]-start[1])*ratio);
  const b = Math.round(start[2] + (end[2]-start[2])*ratio);

  return `rgb(${r},${g},${b})`;
}

function addDepartmentsLayer() {
  if (!window.FR_DEPARTEMENTS_GEOJSON) return;

  if (deptLayer) map.removeLayer(deptLayer);

  deptLayer = L.geoJSON(window.FR_DEPARTEMENTS_GEOJSON, {
    style: feature => {
      const code = feature.properties.code;
      const count = deptCounts[code] || 0;
      return {
        color: "#333",
        weight: 1,
        fillOpacity: 0.55,
        fillColor: getDeptColor(count)
      };
    },
    onEachFeature: (feature, layer) => {
      const code = feature.properties.code;
      const name = feature.properties.nom;
      const count = deptCounts[code] || 0;

      layer.bindPopup(`
        <b>${name}</b><br>
        D√©partement : ${code}<br>
        Agences : <b>${count}</b>
      `);

      layer.on("mouseover", () => layer.setStyle({ weight: 3 }));
      layer.on("mouseout", () => layer.setStyle({ weight: 1 }));
    }
  }).addTo(map);
}

/* ------------------------ MAIN ------------------------ */

async function main() {
  const splash = document.getElementById('splash-screen');
  const progress = document.getElementById('progress');
  const bar = document.getElementById('progressBarInner');

  const records = await fetchAllRecords();
  let done = 0;

  for (const rec of records) {
    const f = rec.fields || {};

    const lat = parseFloat(f["Latitude"]);
    const lng = parseFloat(f["Longitude"]);
    if (isNaN(lat) || isNaN(lng)) continue;

    const name = f["AGENCE "] || f["AGENCE"] || "Sans nom";
    const cp = f["CODE POSTAL"] || "";
    const dept = getDepartmentFromCP(cp);

    if (dept) deptCounts[dept] = (deptCounts[dept] || 0) + 1;

    const address = f["ADRESSE-OK"] || "";
    const type = f["TYPE AGENCE"] || "";
    const type2 = f["TYPE 2"] || "";
    const googleAvis = f["URL Avis Google"] || null;
    const googleNote = f["note_google"] || null;

    let noteStyle = "";
    if (googleNote) {
      const n = parseFloat(googleNote);
      if (n >= 4) noteStyle = "color:#2e7d32;font-weight:bold;";
      else if (n >= 3) noteStyle = "color:#ff9800;font-weight:bold;";
      else noteStyle = "color:#e53935;font-weight:bold;";
    }

    const popupHTML = `
      <div class="popup-content">
        <strong style="font-size:14px;">${name}</strong><br>
        üè¢ <em>${type2 || type}</em><br>
        üìç ${address}<br>
        ${googleNote ? `<div style="${noteStyle}">‚≠ê ${googleNote}/5</div>` : ``}
        ${googleAvis ? `<a href="${googleAvis}" class="google-btn" target="_blank">Voir les avis</a>` : ``}
      </div>
    `;

    const marker = L.marker([lat, lng], { icon: buildIcon(type, googleNote) })
      .addTo(map)
      .bindPopup(popupHTML);

    markers.push({ name, type, type2, marker });

    done++;
    const pct = Math.round((done / records.length) * 100);
    progress.textContent = pct + "%";
    bar.style.width = pct + "%";
  }

  setTimeout(() => splash.style.opacity = 0, 500);
  setTimeout(() => splash.remove(), 1200);

  /* AJOUT DEPARTEMENTS */
  addDepartmentsLayer();
}

/* ----------------- CHARGEMENT GEOJSON LOCAL ----------------- */

window.FR_DEPARTEMENTS_GEOJSON = null;

fetch("departements-100m.geojson")
  .then(res => res.json())
  .then(json => {
    window.FR_DEPARTEMENTS_GEOJSON = json;
    addDepartmentsLayer();
  })
  .catch(err => console.error("Erreur chargement GeoJSON :", err));

main();

/* ----------- RECHERCHE ----------- */

const searchInput = document.getElementById("searchInput");
const resultsList = document.getElementById("resultsList");

searchInput.addEventListener("input", () => {
  const q = searchInput.value.trim().toLowerCase();
  resultsList.innerHTML = "";
  if (!q) {
    resultsList.style.display = "none";
    return;
  }

  const filtered = markers.filter(m =>
    m.name.toLowerCase().includes(q) ||
    m.type.toLowerCase().includes(q) ||
    (m.type2 && m.type2.toLowerCase().includes(q))
  );

  if (filtered.length === 0) {
    resultsList.innerHTML = "<div class='result-item'>Aucune agence trouv√©e</div>";
    resultsList.style.display = "block";
    return;
  }

  filtered.forEach(m => {
    const item = document.createElement("div");
    item.className = "result-item";
    item.innerHTML = `<b>${m.name}</b><br><small>${m.type2 || m.type}</small>`;
    item.onclick = () => {
      map.setView(m.marker.getLatLng(), 13);
      m.marker.openPopup();
      resultsList.style.display = "none";
    };
    resultsList.appendChild(item);
  });

  resultsList.style.display = "block";
});
</script>

</body>
</html>
